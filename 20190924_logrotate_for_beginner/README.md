## 令和の時代にログローテーションの話をする
2019年 9月 松田 弘樹

---

## Who are you ?
2015年5月 合同会社 DMM.com に入社。(5年目突入)    
主に、サーバサイドのエンジニアやってます。  
社内のカメラ部部長やる予定です。きてね。  

---

## 想定する視聴者
ログローテートを知らない人。  
ログローテートの概要を知っているが、どのように設定するかの詳細を知らない人。  

---

## 前提条件
今回解説するのは次の設定です

* OS :CentOS 6.7
* 言語 ：php5.6
* RDB : Mysql

---

## みんな、ログローテートしてる?

---

## ログローテートとは何か

---

## ログローテートとは何か

Log： (実験・業務などの)記録  
Rotate：回転する、循環する、自転する、交替する  
→記録を循環させるソフトウエア

---

## ログローテートの目的

---

## ログローテートの目的
「ログを定期的に削除することで、ログの肥大化を防ぐこと」

---

## ログローテートの種類

---

## ログローテートの種類
* アプリケーション側でのローテーション設定
* OS側のローテション  

大まかに上記の2種類あります。  
本スライドでは、後者を解説していきます。  

---

## ログの種類

---

## ログの種類

サーバで稼動している各種ソフトウエアは、各種ログを出力しています。  
* Linuxのシステムログ(syslog)  
* ソフトウエアログ(access.log, error.log)
* ミドルウエアログ(access.log, mysqlのログ)  

--- 

## ログの種類
### ログ出力の注意点
MW全部のログを１つにまとめるのはやめましょう。お兄さんとの約束だよ。  
ElasticSearchなどでログ解析しようとしたとき、構文解析にが必要なり、余計な手間となります。


---

## ログローテションされないとどうなる?  

---

## ログローテションされないとどうなる?  
サーバのディスク領域を使いきり、ログが書き込めないことでサーバが機能停止する恐れがあります。 

---

## さてここで問題です
次の条件のログサイズはいくつでしょう

---

### 条件
* 集計期間は6ヶ月  
* 基本設定はデフォルト  
* 利用言語は ruby on rails
* ログローテションの設定なし  
* AWSのEC2上で構築  
* ALBのヘルスチェックをデフォルト値で実施  
* 社内システムのため膨大なアクセスはない  

---

## 回答

---

## 回答
約280MB。月間45MB増えていきます。  
5年も放置されると、20GB使い切ってしまいます。

```
# 手動でローテーションしたやつ
-rw-rw-r--  1 ec2-user ec2-user 287399970 Jun 25 19:36 production.log.20190625
```

---

## ログローテートするには?

---

## logrotateを使おう! 
最近のLinuxではデフォルトで導入されている非常にメジャーなソフトウエア。  
パッケージ管理ツールのyumやaptなどのツールで導入しましょう。  

---

## 設定してみよう
`/etc/logrotate.d/ ` 配下に、ソフトウエアや機能単位で設定ファイルを配置しましょう。  

---

## ファイル名例
```
/etc/logrotate.d/apache
/etc/logrotate.d/nginx
/etc/logrotate.d/php-web
/etc/logrotate.d/php-api
```

---

## apacheの記載例
```
cat /etc/logrotate.d/httpd
/var/log/httpd/*log {
    missingok
    notifempty
    sharedscripts
    delaycompress
    postrotate
        /sbin/service httpd reload > /dev/null 2>/dev/null || true
    endscript
}
```

---

## 設定できる項目
| 項目名 | 内容詳細 |
|:------|:--------|
|missingok |指定のログファイルがなくても処理続行 |
|notifempty | ログファイルが空ならスキップ |
|delaycompress| ローテーション1世代目は圧縮しない| 
|daily|毎日実行する|
|rotate [回数]|ローテーションする回数を指定|
|size [ファイルサイズ]|ログファイルが指定したファイルサイズ以上になったらローテーションする|
|postrotate～endscript|記述されたコマンドをログローテーション後に実行|
|compress|ローテーションしたログをgzipで圧縮|

---

## 注意点

---

## 注意点
### 実行権限
logrotateは、root権限で実行しますので削除などには注意しましょう。  
postrotate等でファイル削除コマンドやscriptを実行する場合には必ず検証環境で動作確認してください。  
不適切なスクリプトが実行された場合、最悪システムファイルが破損し、サーバがダウンします  

---

## 注意点
### ログ保管
ローテーションの性質上、古いログファイルは削除されていきます。  
長期的に保管して、分析データとしたしたいような場合は、保管方式や転送方式を検討、設計しましょう  

---

## 最後に
直近は問題ないけど、3年後5年後になると問題が発生する事象もあります。  
こういうところを意識して、エンジニアとしてステップアップしましょう。

---

## 質疑応答

---

## おわり
ご清聴有難うございました。
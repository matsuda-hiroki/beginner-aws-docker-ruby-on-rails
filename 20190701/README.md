ど素人が AWS + Docker + Railsでシステム構築した話。

# はじめに
古きよきEC2のオンプレの構成から、ECS構成に乗せかえる案件を担当したので、  
そこで困ったことはまりポイントなどをまとめます。

## 現行サービス構成

|分類|内容|
| --- | --- |
|言語|Ruby 2.4.0 |
|フレームワーク|Ruby on Rails 5|
|ウェブサーバ |nginx|
|データベース |MariaDB|
|その他|GitHubEnterprise|

## 案件で対応したこと
### Rubyの更新
2.6.2 にバージョンアップ。
### コンテナ技術の採用
ECS+fargateの構成で構築。
### CI/CD自動化対応  
CircleCi、CodePipeline、Code3兄弟(CodeCommit,CodeBuild,CodeDeploy)の導入

## 着任時の筆者のスキル
### サービス開発
オンプレ/AWSでの新規ECサービスの構築経験あり  
### AWS
AWS暦3ヶ月  
AWS認定 クラウドプラクティショナー 所持  
### ruby
素人
### コンテナ/Docker
素人
###  CI/CD
素人。
jenkinsでジョブを触ったことがある程度。

---

# 全般
開発の進め方とか  

## まずはサンプルを動かせるように
ハンズオン資料などを積極的に活用し、最初に動作するもの作ってからの修正、拡張をお勧めします。  
基礎的な部分(VPC、サブネット、セキュリティグループ)などを担保してくれるのではまりどころが減ります。

## 質問できる環境を作ろう
構築経験のある有識者、またはAWSさんのSAに協力依頼して、質問できる環境を構築しましょう。  
変なはまり方をすると、一日進まないなんてこともありえます。  
悩んだ上で相談してみたら、「実は見当違いな場所を調査していた」ということも。   
その際の注意点として、複数人の意見を交互に聞いてると混乱しやすいです。  

## 工数の見積もり
正確な見積もりがひつような場合は、分からないことを出来るだけ少なくしましょう。
分からないことが多いと原因特定に時間がかります。  
分からないものの数だけ、特定する工数が倍ではなく乗算されると思ってください。
エラーが同時が多発的に発生した場合には、精神的にきつくなります。  

---

# AWS編
## IAM
### AWSルートアカウント 
アカウントの分割方針を検討しましょう。  
1アカウントで複数のシステムを管理しようとすると、検索などで非常に分かりにくくなります。  
切り分ける粒度としては、部署単位、システム単位、環境単位などになると思います。  

### 認証情報
チーム用の共通アカウントを作りましょう。
個人のユーザから発行すると、離任したり退職したときにIDが削除されて動かなくなることがあります。

### ポリシーの再作成時時にエラー
CodeBuildで発生したが、以下の記事を参照してた対応した。

```
The policy is attached to 0 entities but it must be attached to a single role
https://qiita.com/kyuaz/items/3da93bd05b1342212577
```

## VPC
VPC中で複数サブネットを構築するので、大きめにとりましょう。  
VPCのCIDRを/24で確保するとIPそのものが不足するか、分かりにくいIP帯になります。

### サブネット
内部セグメントと外部セグメントを分割しましょう。

### ルーティング private subnetから外に接続できない
EIP、natgwやigw、ルートテーブルの設定を確認しましょう

###  DNS登録、SSL証明書発行
route53のAレコード、Cレコードの登録、
ACMの証明書発行はAWSのサポートにホワイトリストに委任設定が必要な場合があります。

## EC2
動作確認用のEC2を作成しておくとよい。問題の切り分けに使えます。

## ALB
ALBから内部セグメントに流すときは、80番ポートで通信しよう。
内部にSSL証明書を設定する必要がなくなるぞ。

## RDB
デフォルト値だと、timezoneがUTCとなっているため日本時間とは時差があります。
パラメータグループの新規作成、パラメータの更新、割り当てと半値いRDB再起動が必要になるため、早いタイミングで修正するとよいです。

## S3
GUIからバケットをコピーをしても、AWSバケットポリシーまではコピーされない。

# ECS	
## ログの出力先について
特性上コンテナ上に出力しているログは、コンテナ削除してしまうと消えます。  
要件によっては、出力先をS3などに変更しましょう。

## デバッグしにくい
Fargateは起動コンテナへのSSHログインなどはできないです。  
ローカル開発環境を用意するか、開発環境を用意してSSH接続できるEC2を選択しましょう。

---

# コンテナ/Docker編

## docker images apline 
ログインシェル bashではなくash。
```
#こけるやつ
docker run --rm -it test-image bash
```
## 公式Docker imageの寿命
docker build時に必要なソフトウエアのインストールを記載することがあると思います。
古いubuntuイメージを使っていると、apt-getでエラーが出るようになった
原因はミラーサイトからの削除されたため。
https://gihyo.jp/admin/clip/01/linux_dt/201903/25
対応としては、OSバージョンを上げることで対応しました。
利用しているOSのサポート期限がいつか意識しておくとよいです。

## docker-composeの違い
当初自分は、DockerfileだけでECS+fargateを構築できると思っていましたが、
docker-composeを作っておくとECSタスク定義に似ているため移行しやすいのでお勧めします。

## 一部Gemライブラリが動かなくなる可能性がある
フロント用のリポジトリでdocker runしたところ、次のエラーが発生。  
```mini_racer_extension.so: undefined symbol: ```   
調査したが、解決方法がみつけられなかったので、alpineとgemの相性問題という判断を下す。
対応として、alpineを断念して別のdocker imageを利用しました。

---

# ruby編

## ソケットについて
configにソケット定義が出来ますが、nginxを立てる場合です。  
dockerではそもそもnginxが不要になるためソケットの定義も不要になります。


ALBで構成では 不要だよ！！
ALBがあるのにenginxコンテナを作ってしまう。
コンテナをECSで実行する場合、デーモナイズモードだとexit 0 する。


---

# CICD編
CICD
	circleci
	yamlインデント

	circleciでは対話モードだととまる
	
	複合役	"システム構成
	CICD AWS どこでdb:migrate実行するか考慮が必要。
	AWS外のCICDツールからdb:migrateを実行しようとすると、
	インターネットからアクセスできるよう穴を開ける必要がある"
	
	codecommit
	circleci	リポジトリが２つあるということは、個別にコミットすると、不一致が起こる。

	複合役	rails docker	12 factorとgit floと、の差分のかんがえ型
	決めておいたほうがいいよ！

	たとえば与える値が変わってくる

複合役	rails docker	構成に影響する　SECRET_KEY_BASE
複合役	rails docker	12 factorとgit floと、の差分のかんがえ型


## Ruby のバージョンアップで躓いたこと
2019年 11月 松田 弘樹

---

## このおじさんだれ?
2015年5月 合同会社 DMM.com に入社。(5年目突入)    
主に、サーバサイドの自称エンジニアやってます。 

---

# はじめに
Ruby `2.4.0` を `2.6.2` にマイナーアップデートする際につまったことをまとめました。

---

# 質問です！

---

# Ruby 使ったことがあるひと

---

# メジャーバージョンアップしたことあるひと?

---

# いってみよー

---

# 心構え  
Ruby のメジャーバージョンアップは、影響範囲は膨大であることを肝に銘じましょう。
BundleやGemなどの便利なものがありますが、依存性などの関係で簡単に動かなくなることがあります。
すんなり移行できることのほうが珍しいと思ってください。

---

## Ruby のパッケージ管理

`gem` と `bundler`  がよく使う

---

## Ruby のパッケージ管理
`gem` 

> Ruby言語用のパッケージ管理システムであり、Rubyのプログラムと（"gem" と呼ばれる）ライブラリの配布用標準フォーマットを提供している。  
gemを容易に管理でき、gemを配布するサーバの機能も持つ  

wikipediaより

---

## Ruby のパッケージ管理

`bundler`  

`gemfile`と`gemfile.lock` に従って、gemを管理をするライブラリ。  
`bundler`も`gem`の一部。  

---

# ruby バージョン定義ファイル
調査のため頻繁に切り替えるので、想定している値か確認しましょう。

| ファイル名 | 説明 |
| --- | --- |
| Gemfile | Gemの定義ファイル |
| Gemfile.lock | Gemfileから生成する |
| .ruby-version | Rubyバージョン定義 |

---

# アップデート順序
Rubyのマイナーバージョンを一気に更新することはよろしくない。  
有識者からの助言があったので、 `2.4.0` → `2.5.0` → `2.6.2` という段階を踏んでアップデートしました。
実例として、`2.4.0` → `2.5.0` への更新は成功するが、`2.5.0` → `2.6.2` でエラーになるケースがありました。

---

## bundle オプション
上は影響度が低く、下ほど影響度が高いです。

| コマンド名 | 説明 |
| --- | --- |
| bundle install | Gemfileに記載があり、Gemfile.lockに記載のないものをインストールします  |
| bundle update {gem名} | 指定したGemのみを更新します  |
| bundle update   | GemfileからGemfile.lockを生成します。 現行のGemfile.lockは破棄します。 |

---

## bundle updateは慎重に  
`bundle update`は、既存の `Gemfile.lock`を破棄し`Gemfile`から`Gemfile.lock`を生成します。 
ここで問題となるケースが、`Gemfile`にバージョン指定がない場合です。
```
# 良い書き方
gem 'puma', '~> 3.11'

# よくない書き方
gem 'rspec-rails'
```
この場合、最新リポジトリを取得しますが、依存性が更新された関係で動かなくなることがあります。 
bundle コマンドの影響の小さいものから試してみましょう。

---

## rbenv: bundle: command not found 
Rubyのバージョンを変更すると、`bundle`が見つからなくなることがあります。

```
# エラーコード
$ bundle update
rbenv: bundle: command not found

The `bundle' command exists in these Ruby versions:
  2.6.2
```

こういった場合は、`bundle`手動インストールしましょう。

```
gem install bundler
```

---

# エラーの調査方法
バージョンアップしてみたらエラーがでちゃった　どうしよう
---
# エラーの調査方法
## 正常に動作している環境を確保する
まず正常動作する環境を確保しましょう。
これができると「実行環境の問題」か、「コードの問題」か切り分けが出来るようになります。
別環境で正常動作しているものを見つけ、自分の環境で動作させてみましょう。
`新規Railsアプリケーションを構築` でもいいと思います。

---
# エラーの調査方法
## 依存性を確認しよう
Gemの動作要件として、別のGemが指定されていることがよくあります。
Gemの最新バージョンを取得すると、現行バージョンと比較して次のようなケースがあります。

- 要求するGemのバージョン指定が上がった
- 要求するGemが、不要になった
- 要求するGemが、差し替えられた

ややこしいのですが、`rubygems.org` のサイトで検索を行い、`runtime 依存性` を確認してみましょう。
https://rubygems.org/
別環境で動いているコードがあるのでしたら、当該部分の`Gemfile.lock`の記述をあわせてみて動作確認してみましょう。

---
# エラーの調査方法
## Gem公式ページの確認
Gemで提供しているライブラリは、Githubで管理されていることが多いと思います。
公式ページを確認し、不具合issueがないか確認しましょう。修正中や本番リリース待ちだったりします。
急いでいる場合は、`Gemfile.lock`を編集して動作確認できたバージョンまでダウングレードることで対応しましょう。

## Ruby のバージョンアップで躓いたこと
2019年 11月 松田 弘樹

---

## このおじさんだれ?
2015年5月 合同会社 DMM.com に入社。(5年目突入)    
主に、サーバサイドの(自称)エンジニアやってます。 

---

# 今日話すこと

Ruby `2.4.0` を `2.6.2` にアップデートする際につまったことをまとめました。

---

# 質問です！

---

# Ruby 使ってるひと?

---

# Ruby バージョンアップの経験あるひと?

---

# いってみよー

---

# 心構え  

---

# 心構え  
Ruby のバージョンアップは、影響範囲は膨大であることを肝に銘じましょう。  
BundleやGemなどの便利なものがありますが、しっかりした設計がされていないと依存性でいとも簡単に動かなくなります。  
すんなり移行できることのほうが珍しいと思ってください。  

---

## trouble shooting
バージョンアップしてみたらエラーがでちゃった  

---

## 正常に動作している環境を確保する
Ruby が正常動作する環境を確保しましょう。  
これができると「実行環境の問題」か、「コードの問題」か切り分けが出来るようになります。  
別環境で正常動作しているものを見つけ、自分の環境で動作させてみましょう。  
`新規Railsアプリケーションを構築` でもいいと思います。  

---

## 依存性を確認しよう
Gemの動作要件として、別のGemがバージョン指定されていることがよくあります。  
Gemの最新バージョンを取得すると、現行バージョンと比較して次のような変更されることがあります。  

- 要求するGemのバージョン指定が上がった
- 要求するGemが、不要になった
- 要求するGemが、差し替えられた

---

## 依存性を確認しよう
`rubygems.org` のサイトで検索を行い、`runtime 依存性` を確認してみましょう。  
別環境で動いているコードがあるのでしたら、当該部分の`Gemfile.lock`の記述をあわせてみて動作確認してみましょう。  

---

## Gem公式ページの確認
公式ページを確認し、不具合issueがないか確認しましょう。  
修正中や本番リリース待ちだったりします。  
急いでいる場合は、`Gemfile.lock`を編集して動作確認できたバージョンまでダウングレードして対応することもできます。

---

# Ruby

---

## Ruby バージョン定義ファイル
調査のため頻繁に切り替えるので、想定している値か確認しましょう。

| ファイル名 | 説明 |
| --- | --- |
| Gemfile | Gemの定義ファイル |
| Gemfile.lock | Gemfileから生成する |
| .ruby-version | Rubyバージョン定義 |

---

## Ruby アップデート順序
Rubyのバージョンを上げる際に、一気にバージョンを上げると危険との情報を頂いたので、私は `2.4.0` → `2.5.0` → `2.6.2` という段階を踏んでアップデートしました。  

`2.4.0` → `2.5.0` はバージョンアップ成功するが、 
`2.5.0` → `2.6.2` はエラーとなるケースがありました。  
問題点切り分けのためにも、段階を踏んでバージョンアップを検討しましょう。

---

# bundle

---

## bundle オプション
| コマンド名 | 説明 |
| --- | --- |
| bundle install | Gemfileに記載があり、Gemfile.lockに記載のないものをインストールします  |
| bundle update {gem名} | 指定したGemのみを更新します  |
| bundle update   | GemfileからGemfile.lockを生成します。  古いGemfile.lockは破棄します。 |

上は影響度が低く、下ほど影響度が高いです。
---

## bundle updateは慎重に  
`bundle update`は、既存の `Gemfile.lock`を破棄し`Gemfile`から`Gemfile.lock`を生成します。 
ここで問題となるケースが、`Gemfile`にバージョン指定がない場合です。
```
# 良い書き方
gem 'puma', '~> 3.11'

# よくない書き方
gem 'rspec-rails'
```

---

## bundle updateは慎重に  
`Gemfile`にバージョン指定がない場合、最新リポジトリを取得します。  
ここで依存性が更新された関係で動かなくなることがあります。   
先に述べた `bundle` コマンドの影響の小さいものから試してみましょう。

---

## rbenv: bundle: command not found 
Rubyのバージョンを変更すると、`bundle` が見つからなくなることがあります。

```
# エラーコード
$ bundle update
rbenv: bundle: command not found

The `bundle' command exists in these Ruby versions:
  2.6.2
```

---

## rbenv: bundle: command not found 
Ruby バージョン単位で `bundle` のインストールが必要となります。  
Ruby バージョンを切り替えて手動でインストールしましょう。
```
gem install bundler
```

---

# 参考なったかな？

---

# ご清聴ありがとうございました

---


# 質疑応答


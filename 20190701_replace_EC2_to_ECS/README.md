コンテナど素人が、EC2からECSにシステムリプレースした話

# はじめに
古きよきEC2のオンプレの構成から、ECS構成に乗せかえる案件を担当したので、  
そこで困ったことはまりポイントなどをまとめます。

## 現行サービス構成

|分類|内容|
| --- | --- |
|言語|Ruby 2.4.0 |
|フレームワーク|Ruby on Rails 5|
|ウェブサーバ |nginx|
|データベース |MariaDB|
|その他|GitHubEnterprise|

## 対応したこと
### Rubyのメジャーバージョンアップ
`2.4.0`から`2.6.2`に更新
### コンテナ技術の採用
ECS + fargateの構成で構築
### CI/CD自動化対応  
CircleCi、CodePipeline、Code3兄弟(CodeCommit,CodeBuild,CodeDeploy)の導入

## 着任時の筆者のスキル
### サービス開発
オンプレ/AWSでの新規ECサービスの構築、開発、保守運用、経験あり。
### AWS
AWS暦3ヶ月  
AWS認定 クラウドプラクティショナー 所持  
### ruby
素人
### コンテナ/Docker
素人
###  CI/CD
素人  
jenkinsでジョブを触ったことがある程度。

---

# 全般
開発の進め方とか  

## まずはサンプルを動かせるように
ハンズオン資料などを積極的に活用し、最初に動作するもの作ってからの修正、拡張をお勧めします。  
AWS Well-Architectedが適用されており、基礎的な部分(VPC、サブネット、セキュリティグループ)などを担保してくれるので、はまりどころが減ります。

## 質問できる環境を作ろう
構築経験のある有識者、またはAWSさんのSAに協力依頼して、質問できる環境を構築しましょう。  
変なはまり方をすると、一日進まないなんてこともありえます。  
悩んだ上で有識者に相談してみたら、「実は見当違いな場所を調査していた」ということも。   
注意点として、複数人の意見を一度にまとめて聞くと、受け取る側の処理が追いつかず、混乱する可能性があります。

## 工数の見積もり
正確な見積もりがひつような場合は、分からないことを出来るだけ少なくしましょう。
分からないことが多いと原因特定に時間がかります。  
分からないものの数だけ、特定する工数が倍ではなく乗算されると思ってください。
エラーが同時が多発的に発生した場合には、精神的にきつくなります。  

---

# AWS編
## IAM
### AWSルートアカウント 
アカウントの分割方針を検討しましょう。  
1アカウントで複数のシステムを管理しようとすると、検索などで非常に分かりにくくなります。  
切り分ける粒度としては、部署単位、システム単位、環境単位などになると思います。  

### 認証情報
チーム用の共通アカウントを作りましょう。  
個人のユーザから発行すると、離任したり退職したときにIDが削除されて動かなくなることがあります。

### ポリシーの再作成時時にエラー
テスト用に作成したポリシー削除して作り直したが、CodeBuildでエラー発生。  
以下の記事を参照して対応した。ポリシー削除時に、追加で消さなければいけなかったようです。

```
The policy is attached to 0 entities but it must be attached to a single role
https://qiita.com/kyuaz/items/3da93bd05b1342212577
```

## VPC
VPC中で複数サブネットを構築するので、大きめにとりましょう。  
VPCのCIDRを/24で確保するとIPそのものが不足するか、分かりにくいIP帯になります。

### サブネット
内部セグメントと外部セグメントを分割しましょう。

### ルーティング private subnetから外に接続できない
EIP、natgwやigw、ルートテーブルの設定を確認しましょう

###  DNS登録、SSL証明書発行
route53のAレコード、Cレコードの登録、
ACMの証明書発行はAWSのサポートにホワイトリストに委任設定が必要な場合があります。

## EC2
動作確認用のEC2を作成しておくとよい。問題の切り分けに使えます。

## ALB
ALBから内部セグメントに流すときは、80番ポートで通信しよう。
内部にSSL証明書を設定する必要がなくなるぞ。

## RDB
デフォルト値だと、timezoneがUTCとなっているため日本時間とは時差があります。
パラメータグループの新規作成、パラメータの更新、割り当てと半値いRDB再起動が必要になるため、早いタイミングで修正するとよいです。

## S3
GUIからバケットをコピーをしても、AWSバケットポリシーまではコピーされない。

# ECS	
## ログの出力先について
特性上コンテナ上に出力しているログは、コンテナ削除してしまうと消えます。  
要件によっては、出力先をS3などに変更しましょう。

## デバッグしにくい
Fargateは起動コンテナへのSSHログインなどはできないです。  
ローカル開発環境を用意するか、開発環境を用意してSSH接続できるEC2を選択しましょう。

---

# コンテナ/Docker編

## apline image
ログインシェル bashではなくash。
```
# ログインシェル指定まちがえでエラーとなる
docker run --rm -it test-image bash
# 以下ならOK
docker run --rm -it test-image ash
docker run --rm -it test-image sh

```
## 公式Docker imageの寿命
`docker build`時に必要なソフトウエアのインストール時、古いubuntuイメージを使っていると、apt-getでエラーが出る事例がありました。
原因は古いバージョンの情報が。ミラーサイトからの削除されたため。  
https://gihyo.jp/admin/clip/01/linux_dt/201903/25    
対応としては、imageのバージョンを上げることで対応しました。  
利用しているOSのサポート期限がいつか意識しておくとよいです。  
サポート期限が切れているものは、明日にでもDockerfileが使えなくなるものとして早急に更新をお勧めします。  

## docker-compose
当初自分は、DockerfileだけでECS+fargateを構築できると思っていましたが、
docker-composeを作っておくと、次の利点があるので作成をお勧めします。  
・不具合が発生した場合のデバッグ環境の用意。
・ECSタスク定義と近い環境となり、本番環境作成にスムーズに移行しやすい。

## 一部Gemライブラリが動かなくなる可能性があり
フロント用のリポジトリで`docker run`したところ、次のエラーが発生。  
```mini_racer_extension.so: undefined symbol: ```   
エラーを調査したが、有効な解決方法がみつけられなかったので、alpineとgemの相性問題という最終判断しました。  
対応として、alpineを断念してruby公式のDocker imageを利用しました。

## プロセス起動オプションについて
プロセス起動コマンドをDockerfileで記載しますが、バックグラウンド実行オプションは外しましょう。  
Dockerfile側でバックグラウンドオプションをつけると、のcontainerそのものが停止してしまいます。  
バックグラウンド起動したい場合は、`docker run`時に`-d`オプションをつけて対応しましょう。  

---

# Ruby編

## puma利用時
今回の構成では、次のようなwebサーバが機能が不要になりました。  
・nginxのプロセス   
・rubyが出力するnginxソケット定義  

## バージョンアップに伴う影響
更新された際に、`config/database.yml` が必要となっていました。  
使われないはずの設定ファイルですが、取り急ぎ動作のため追加しました。
なぜ必要になったのかという疑問については、事項として後日調査という形にしました。  

---

# CI/CD編
## yamlファイル
インデントに厳密です。動くサンプル見ながら試行錯誤してました。  

## 対話モードだととまる
CI/CDの性質上、対話モードでの動作を想定していません。  
対話を求められないようにしましょう
例
```
rmコマンド
パッケージ管理系コマンド(yum,apt-get,apk)
```



	codecommit
	circleci	リポジトリが２つあるということは、個別にコミットすると、不一致が起こる。





CICD AWS どこでdb:migrate実行するか考慮が必要。
AWS外のCICDツールからdb:migrateを実行しようとすると、
インターネットからアクセスできるよう穴を開ける必要がある"



	
	複合役	rails Docker	12 factorとgit floと、の差分のかんがえ型
	決めておいたほうがいいよ！

	たとえば与える値が変わってくる


構成に影響する　SECRET_KEY_BASE
12 factorとgit floと、の差分のかんがえ型


# できなかったこと
通知


# 質疑応答

# おわり
ご清聴ありがとうごさいました。
